"use strict";var view=function(){var e={},i={},t,n,r,o,a,d,s,c,l,u,f,p,m;t=function(e){if(e!==undefined){i.dfb=e}return i.dfb};e.dfb=t;n=function(e){d3.select("#working_icon").classed("invisible",!e)};e.loading=n;r=function(e,t){d3.select("#working_icon").classed("invisible",!t);d3.selectAll(e+" .calc").classed("hidden",!t);d3.selectAll(e+" .calc-done").classed("hidden",t)};e.calculating=r;o=function(e){d3.select("div#error").classed("hidden",false).append("p").text(e);this.loading(false)};e.error=o;a=function(e){d3.select("div#warning").classed("hidden",false).append("p").text(e)};e.warning=a;d=function(){var e=i.tooltip;if(e){return e}e={offset:VIS.tooltip.offset};e.div=d3.select("body").append("div").attr("id","tooltip").classed("bar_tooltip",true);e.container=d3.select("body").node();e.div.append("p");e.update_pos=function(){var e=d3.mouse(this.container);this.div.style({left:e[0]+this.offset.x+"px",top:e[1]+this.offset.y+"px",position:"absolute"})};e.text=function(e){this.div.select("p").text(e)};e.show=function(){this.div.classed("hidden",false)};e.hide=function(){this.div.classed("hidden",true)};i.tooltip=e;return e};e.tooltip=d;s=function(t){var e=t.models.find(function(e){return e.id===t.id});if(t.title){d3.selectAll(".model_title").html(t.title)}if(t.models&&t.models.length>1){d3.select("ul#data_dropdown").selectAll("li").data(t.models).enter().append("li").append("a").attr("href","#").text(function(e){return e.name||e.id}).on("click",function(e){d3.event.preventDefault();d3.select("#data_name").text(e.name||e.id);i.dfb.switch_model(e.id)});d3.select("#data_name").text(e.name||e.id);d3.select("li#nav_data").classed("hidden",false)}};e.frame=s;c=function(e,t){var i,n=["."+e];d3.selectAll(".annote").classed("hidden",true);for(i=0;i<t.length;i+=1){n.push(n[i]+"_"+String(t[i]).replace(/\W/g,"_"))}n.forEach(function(e){d3.selectAll(".annote"+e).classed("hidden",false)})};e.update_annotations=c;l=function(t){if(t.w){t.enter.append("td").classed("weight",true).append("div").classed("proportion",true).append("span").classed("proportion",true).html("&nbsp;");t.sel.select("td.weight div.proportion").style("margin-left",function(e){return d3.format(".1%")(1-t.w(e))})}if(t.frac){t.enter.append("td").classed("td-right",true).classed("weight-percent",true);t.sel.select("td.weight-percent").text(t.frac)}if(t.raw){t.enter.append("td").classed("td-right",true).classed("weight-raw",true);t.sel.select("td.weight-raw").text(t.raw)}};e.weight_tds=l;u=function(e,t){e.attr("width",t.w+t.m.left+t.m.right).attr("height",t.h+t.m.top+t.m.bottom);return e.select("g").attr("transform","translate("+t.m.left+","+t.m.top+")")};e.setup_plot=u;f=function(e){return e.append("svg").append("g")};e.append_plot=f;p=function(){window.scrollTo(window.scrollX,0)};e.scroll_top=p;m=function(){window.scrollTo(0,0)};e.scroll_origin=m;return e}();"use strict";var metadata=function(e){var n=e||{},t={},i,r,o,a,d,s,c,l,u;n.conditionals=d3.map();n.by_id={};r=function(e){if(typeof e!=="string"){return}n.docs=d3.csv.parse(e);i()};t.from_string=r;i=function(){if(!Array.isArray(n.docs)){return}if(n.id&&!n.docs[0].hasOwnProperty(n.id)){view.warning("Metadata does not have an ID column named "+n.id);n.id=undefined}if(n.date_field&&!Array.isArray(n.date_field)){n.date_field=[n.date_field]}n.date_field=n.date_field.filter(function(e){var t=n.docs[0].hasOwnProperty(e);if(!t){view.warning("Did not find specified date field "+e)}return t});n.docs.forEach(function(t){n.date_field.forEach(function(e){t[e]=new Date(t[e])})})};t.validate=i;o=function(e){if(typeof e==="object"){n.bib=e}return n.bib};t.bib=o;a=function(e){if(e!==undefined){n.id=e}return n.id};t.id_field=a;d=function(e){var t;if(e===undefined){return n.docs}t=c(e);if(Array.isArray(t)){return t.map(function(e){return n.docs[e]})}return n.docs[t]};t.doc=d;s=function(e){if(e===undefined){return n.docs.map(function(e,t){return s(t)})}if(n.id===undefined){return e}if(Array.isArray(e)){return e.map(function(e){return n.docs[e][n.id]})}return n.docs[e][n.id]};t.doc_id=s;c=function(e){if(Array.isArray(e)){return e.map(c)}if(!n.id){return+e}if(n.by_id[n.id]===undefined){n.by_id[n.id]=d3.map();n.docs.forEach(function(e,t){n.by_id[n.id].set(e[n.id],t)});if(n.by_id[n.id].size()!==n.docs.length){view.error('Document IDs in metadata column "'+n.id+'" are not unique.')}}return n.by_id[n.id].get(e)};t.doc_index=c;l=function(){if(n.docs){return n.docs.length}};t.n_docs=l;u=function(e,t,i){if(t===undefined){return n.conditionals.get(e)}n.conditionals.set(e,t(i,n.docs));return this};t.condition=u;return t};metadata.key={ordinal:function(t,e){var i=function(e){return e[t.field].replace(/\s/g,"_")};i.invert=function(e){return e.replace(/_/g," ")};i.display=i.invert;i.range=d3.set(e.map(i)).values();i.range.sort();return i},continuous:function(i,e){var n=d3.extent(e,function(e){return+e[i.field]}),t,r,o,a;n[0]=Math.floor(n[0]/i.step)*i.step;t=Math.floor(Math.log10(i.step));r=Math.ceil(Math.log10(d3.max(n,Math.abs)));if(r>=1){if(t<=0){o=d3.format("0"+String(r+Math.abs(t)+1)+"."+String(Math.abs(t))+"f")}else{o=d3.format("0"+String(r)+".0f")}}else{o=d3.format("."+String(Math.abs(t))+"f")}a=function(e){var t=n[0]+Math.floor((+e[i.field]-n[0])/i.step)*i.step;return o(t)};a.invert=function(e){return+e};a.display=function(e){return String(+e)+"–"+String(+e+i.step)};a.range=d3.range(Math.floor((n[1]-n[0])/i.step)).map(function(e){return o(n[0]+e*i.step)});return a},time:function(t,e){var i=d3.extent(e,function(e){return e[t.field]}),n,r,o,a,d,s,c,l=t.n||1,u=d3.time[t.unit].utc;n=[i[0]];r=u.offset(i[0],l);while(r<i[1]){n.push(r);r=u.offset(r,l)}o=function(e){return n[d3.bisect(n,e)-1]};switch(t.unit){case"year":s="%Y";break;case"month":s="%Y-%m";break;case"day":s="%Y-%m-%d";break;case"hour":s="%Y-%m-%d %H:00";break;case"minute":s="%Y-%m-%d %H:%M";break;case"second":s="%Y-%m-%d %H:%M:%S";break;default:o=function(e){return new Date(+i[0]+Math.floor((+e-+i[0])/l)*l)};s="%Y-%m-%dT%H:%M:%S.%LZ";break}a=d3.time.format.utc(s);if(l===1){d=function(e){return a(e[t.field])}}else{d=function(e){return a(o(e[t.field]))}}d.invert=function(e){return a.parse(e)};if(t.format){c=function(e){return d3.time.format.utc(t.format)(a.parse(e))}}else{c=function(e){return e}}if(l===1){d.display=function(e){return c(e)}}else{d.display=function(e){return c(e)+"–"+c(a(u.offset(a.parse(e),l)))}}d.range=n.map(o).map(a);return d}};"use strict";var bib=function(e){var r=e||{},l={},t,i,n,o;if(!r.sorting){r.sorting=[["all_raw","by raw entry"]]}t=function(e){if(e!==undefined){r.sorting=e}return r.sorting};l.sorting=t;l.keys={};l.keys.all=function(){return"All"};l.keys.raw=function(e){return JSON.stringify(e)};i=function(i){var e=[],t,n=i.dir.major?d3.ascending:d3.descending,r=i.dir.minor?d3.ascending:d3.descending,o=function(e){return e.id},a,d,s,c=[];t=i.docs.map(function(e,t){return{id:i.doc_ids[t],major:l.keys[i.major](e),minor:l.keys[i.minor](e)}}).sort(function(e,t){return n(e.major,t.major)||r(e.minor,t.minor)||d3.ascending(e.id,t.id)});for(d=0,a="";d<t.length;d+=1){if(t[d].major!==a){c.push(d);e.push({heading:t[d].major});a=t[d].major}}c.shift();c.push(t.length);for(d=0,s=0;d<c.length;d+=1){e[d].docs=t.slice(s,c[d]).map(o);s=c[d]}if(typeof l.keys[i.major].display_heading==="function"){e.forEach(function(e){e.heading_display=l.keys[i.major].display_heading(e.heading)})}return e};l.sort=i;i.validate=function(e){var t=r.sorting.map(function(e){return e[0].split("_")[0]}),i=r.sorting.map(function(e){return e[0].split("_")[1]}),n=e;if(t.indexOf(e.major)===-1){n.major=undefined}if(i.indexOf(e.minor)===-1){n.minor=undefined}if(e.dir!=="up"&&e.dir!=="down"){n.dir=undefined}return n};i.dir=function(e){return{major:e.dir!=="down",minor:true}};n=function(e){var t,i="";for(t in e){if(e.hasOwnProperty(t)&&typeof e[t]==="string"){i+=e[t]+". "}}return i};l.citation=n;o=function(){return""};l.url=o;return l};"use strict";var VIS={files:{info:"data/info.json",meta:"data/meta.csv.zip",dt:"data/dt.json.zip",tw:"data/tw.json",topic_scaled:"data/topic_scaled.csv"},aliases:{yearly:"conditional"},default_view:"/model",metadata:{type:"dfr",spec:{extra_fields:[],date_field:"date"}},condition:{type:"time",spec:{field:"date",unit:"year",n:1}},overview_words:15,model_view:{plot:{w:500,aspect:1.3333,words:6,size_range:[7,18],name_size:18,stroke_range:6},conditional:{w:500,aspect:1.333,m:{left:20,right:20,top:20,bottom:30},label_threshold:40,words:4,label_words:2,streamgraph:true,ordinal:{bar:.4}},list:{spark:{w:70,h:20,m:{left:2,right:2,top:2,bottom:2},time:{bar:{unit:"day",w:300}},ordinal:{bar:{w:.25}},continuous:{bar:{w:.25}}}}},topic_view:{words:50,docs:20,w:400,aspect:3,m:{left:40,right:20,top:20,bottom:30},time:{bar:{unit:"day",w:90},ticks:10},continuous:{bar:{w:.25},ticks:10},ordinal:{bar:{w:.25},ticks:10},ticks_y:10,tx_duration:1e3},word_view:{n_min:10,topic_label_padding:8,topic_label_leading:14,row_height:80,svg_rows:10,w:700,m:{left:100,right:40,top:20,bottom:0}},bib:{type:"dfr",spec:{author_delimiter:"\t",et_al:Infinity,anon:"[Anon]"}},bib_view:{window_lines:100,major:"year",minor:"authortitle",dir:"up"},tooltip:{offset:{x:10,y:0}},percent_format:".1%",resize_refresh_delay:100,hidden_topics:[],show_hidden_topics:false};"use strict";var model;model=function(e){var o=e||{},r={},t,i,n,a,d,s,c,l,u,f,p,m,w,_,v,h,g,y,b,x,k,A,S,I,j,V,z,M,E,N;o.ready={};o.worker=new Worker("js/worker.min.js");o.worker.fs=d3.map();o.worker.onmessage=function(e){var t=o.worker.fs.get(e.data.what);if(t){t(e.data.result)}};o.worker.callback=function(e,t){o.worker.fs.set(e,t)};i=function(){var e;if(o.n_docs!==undefined){e=o.n_docs}else if(o.meta){e=o.meta.n_docs()}return e};r.n_docs=i;t=function(e){return!!o.ready[e]};r.ready=t;a=function(e){if(!o.topic_ids){return+e-1}return o.topic_ids.get(e)};r.topic_index=a;n=function(e){if(!o.ids){return+e+1}return o.ids[e]};r.topic_id=n;d=function(e,t){if(!o.tw){return undefined}if(e===undefined){return o.tw}if(t===undefined){return o.tw[e]}return o.tw[e].get(t)};r.tw=d;s=function(){return o.n};r.n=s;c=function(){if(!this.tw()){return undefined}return o.tw[0].keys().length};r.n_top_words=c;l=function(){return o.proper};r.proper=l;u=function(t){if(!o.total_tokens){o.worker.callback("total_tokens",function(e){o.total_tokens=e;t(e)});o.worker.postMessage({what:"total_tokens"})}else{t(o.total_tokens)}};r.total_tokens=u;f=function(e,t){var i=isFinite(e)?e:"all";o.worker.callback("topic_total/"+i,t);o.worker.postMessage({what:"topic_total",t:i})};r.topic_total=f;p=function(e){if(!o.alpha){return undefined}return isFinite(e)?o.alpha[e]:o.alpha};r.alpha=p;m=function(e){if(e){o.meta=e;o.ready.meta=true}return o.meta};r.meta=m;w=function(e,t,i,n){if(t!==undefined){if(!o.ready["meta_"+e]){o.meta.condition(e,t,i);_(e,o.meta.condition(e),n)}else if(typeof n==="function"){n()}}return o.meta.condition(e)};r.meta_condition=w;_=function(t,e,i){var n;n=o.meta.doc().map(e);o.worker.callback("set_doc_categories/"+t,function(e){o.ready["meta_"+t]=e;if(typeof i==="function"){i()}});o.worker.postMessage({what:"set_doc_categories",v:t,keys:n})};v=function(){if(!o.meta){return undefined}return o.meta.bib()};r.bib=v;h=function(e){var t=d3.set(),i;if(!d()){return undefined}if(isFinite(e)){d(e).keys().forEach(t.add)}else{if(e===undefined){i=d()}else{i=e.map(function(e){return r.tw(e)})}i.forEach(function(e){e.keys().forEach(function(e){t.add(e)})})}return t.values().sort()};r.vocab=h;g=function(e){if(!o.topic_scaled){return undefined}if(e===undefined){return o.topic_scaled}return o.topic_scaled[e]};r.topic_scaled=g;b=function(e,t,i){var n=t===undefined?"all":t,r=n!=="all"?i:function(e){i(d3.map(e))};o.worker.callback("conditional_total/"+e+"/"+n,r);o.worker.postMessage({what:"conditional_total",v:e,key:n})};r.conditional_total=b;y=function(e,t,i){var n=e===undefined?"all":e,r;if(n==="all"){r=function(e){i(e.map(d3.map))}}else{r=function(e){i(d3.map(e))}}o.worker.callback("topic_conditional/"+t+"/"+n,r);o.worker.postMessage({what:"topic_conditional",t:n,v:t})};r.topic_conditional=y;x=function(e,t,i){o.worker.callback("topic_docs/"+e+"/"+t,i);o.worker.postMessage({what:"topic_docs",t:e,n:t})};r.topic_docs=x;k=function(e,t,i,n,r){o.worker.callback(["topic_docs_conditional",e,t,i,n].join("/"),r);o.worker.postMessage({what:"topic_docs_conditional",t:e,v:t,key:i,n:n})};r.topic_docs_conditional=k;S=function(e,t,i){o.worker.callback("doc_topics/"+e+"/"+t,i);o.worker.postMessage({what:"doc_topics",d:e,n:t})};r.doc_topics=S;A=function(e,t){var i=t||this.n_top_words(),n;if(e===undefined){return d3.range(this.n()).map(function(e){return r.topic_words(e,t)})}n=this.tw(e).entries();n.sort(function(e,t){return d3.descending(e.value,t.value)||d3.ascending(e.key,t.key)});return utils.shorten(n,i,function(e,t){return e[t].value}).map(function(e){return{word:e.key,weight:e.value}})};r.topic_words=A;I=function(e,t){var i,n,r,o=t||this.n_top_words(),a=[],d=function(e){return e.values().reduce(function(e,t){return t>r?e+1:e},0)};for(i=0;i<this.n();i+=1){n=this.tw(i);if(n.has(e)){r=n.get(e);a.push({topic:i,rank:d(n)})}}a.sort(function(e,t){return d3.ascending(e.rank,t.rank)||d3.ascending(e.topic,t.topic)});return utils.shorten(a,o,function(e,t){return e[t].rank})};r.word_topics=I;j=function(e){var t=String(e+1);if(o.topic_labels&&o.topic_labels[t]){return o.topic_labels[t]}return"Topic"+" "+n(e)};r.topic_label=j;V=function(e){o.topic_labels=e};r.set_topic_labels=V;z=function(e){o.ids=e;if(Array.isArray(o.ids)){if(o.n&&o.ids.length!==o.n){o.ids=undefined;return}o.topic_ids=d3.map();e.forEach(function(e,t){o.topic_ids.set(e,t)})}};r.set_topic_ids=z;E=function(e){var t;if(typeof e!=="string"){return}t=JSON.parse(e);o.alpha=t.alpha;o.tw=t.tw.map(function(i){var n=d3.map();i.words.map(function(e,t){n.set(e,i.weights[t])});return n});if(!o.n){o.n=o.alpha.length}o.ready.tw=true};r.set_tw=E;M=function(e,t){if(typeof e!=="string"){t(false)}o.worker.callback("set_dt",function(e){o.ready.dt=e.success;o.proper=e.proper;t(e)});o.worker.postMessage({what:"set_dt",dt:JSON.parse(e)})};r.set_dt=M;N=function(e){var t;if(typeof e==="string"){t=e.replace(/^\n*/,"").replace(/\n*$/,"\n");o.topic_scaled=d3.csv.parseRows(t,function(e){return e.map(parseFloat)})}o.ready.topic_scaled=true};r.set_topic_scaled=N;return r};"use strict";bib.dfr=function(e){var a=e||{},t=bib(a),n;t.sorting([["year_authortitle","by year, then by author"],["issue_journalcontents","by journal issue"],["year_journalcontents","by year, then by journal contents"],["decade_date","chronologically by decades"],["decade_authortitle","by decades, then by author"],["author_authortitle","alphabetically by author"]]);t.keys.author=function(e){return n(e.authors).replace(/^\W*/,"")[0].toUpperCase()};t.keys.authortitle=function(e){var t=n(e.authors)+e.title;return t.toLowerCase()};t.keys.decade=function(e){return Math.floor(e.date.getUTCFullYear()/10).toString()+"0s"};t.keys.year=function(e){return e.date.getUTCFullYear()};t.keys.journal=function(e){return e.journal};t.keys.issue=function(e){var t=e.journal;t+="_"+d3.format("05d")(e.volume);if(e.issue){t+="_"+e.issue}return t};t.keys.issue.display_heading=function(e){var t,i;t=e.split("_");i=t[0]+" "+String(+t[1]);if(t.length>2){i+="."+t[2]}return i};t.keys.date=function(e){return+e.date};t.keys.journalcontents=function(e){var t=e.journal;t+=d3.format("05d")(e.volume);t+=d3.format("05d")(e.issue===""?0:e.issue.replace(/\/.*$/,""));if(e.pagerange.search(/^\d/)!==-1){t+=d3.format("05d")(e.pagerange.match(/^(\d+)/)[1])}else{t+=e.pagerange}return t};t.sort.dir=function(e){var t={major:true,minor:true};if(e.dir==="up"){return t}if(e.dir==="down"){t.major=false;if(e.major==="decade"||e.major==="year"||e.major==="issue"){t.minor=e.minor!=="date"&&e.minor!=="journal"}else if(e.major==="alpha"||e.major==="journal"){t.minor=e.minor!=="alpha"}else{t.minor=true}}return t};n=function(e){var t,i,n,r=e.split(a.author_delimiter).filter(function(e){return/\S/.test(e)}),o=r.length;if(o===0){return a.anon}t=r[0].replace(/,/g,"").split(" ");i=t.pop();if(t.length>=2&&i.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){n=t.pop().replace(/_$/,"");i=", "+i.replace(/\W*$/,"")}else{n=i;i=""}n+=", "+t.join(" ")+i;if(o>1){if(o>=a.et_al){n+=", ";n+=r.slice(1,a.et_al).join(", ");n+="et al."}else{if(o>2){n+=", "}n+=r.slice(1,o-1).join(", ");n+=", and "+r[o-1]}}return n};t.doc_author=n;t.citation=function(e){var t=n(e.authors),i;t=t.replace(/\.?$/,". ");i=e.title.replace(/“/g,"‘").replace(/”/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1‘").replace(/"/g,"’").replace(/'/g,"’").replace(/ <br><\/br>/g,". ");t+="“"+i+".”";t=t.replace(/’\./g,".’");t+=" <em>"+e.journal+"</em> ";t+=e.volume;if(e.issue){t+=", no. "+e.issue}t+=" ("+d3.time.format.utc("%B %Y")(e.date)+"): ";t+=e.pagerange+".";t=t.replace(/\.\./g,".");t=t.replace(/_/g,",");t=t.replace(/\t/g,"");return t};t.url=function(e){return"http://www.jstor.org"+"/stable/"+e.doi};return t};"use strict";metadata.dfr=function(e){var n=e||{},i,t;n.date_field=n.date_field||["date"];if(!Array.isArray(n.date_field)){n.date_field=[n.date_field]}if(n.date_field.indexOf("date")===-1){n.date_field.push("date")}i=metadata(n);if(!Array.isArray(n.extra_fields)){n.extra_fields=[]}t=function(e){var t;if(typeof e!=="string"){return}t=e.replace(/^\n*/,"").replace(/\n*$/,"\n");n.docs=d3.csv.parseRows(t,function(e,t){var i;i={doi:e[0].trim(),title:e[1].trim(),authors:e[2].trim(),journal:e[3].trim(),volume:e[4].trim(),issue:e[5].trim(),date:e[6].trim(),pagerange:e[7].trim().replace(/^p?p\. /,"").replace(/-/g,"–")};e.slice(8,e.length).forEach(function(e,t){i[n.extra_fields[t]||"X"+String(t+1)]=e.trim()});return i});i.validate()};i.from_string=t;return i};"use strict";view.about=function(e){if(e.meta_info){d3.select("div#meta_info").html(e.meta_info)}return true};"use strict";view.bib=function(i){var e=i.ordering.map(function(e){var t=e;e.key=e.heading+"_"+i.minor+"_"+i.dir;return t}),t;d3.selectAll("select#select_bib_sort option").each(function(){this.selected=this.value===i.major+"_"+i.minor});d3.selectAll("select#select_bib_dir option").each(function(){this.selected=this.value===i.dir});d3.select("select#select_bib_sort").on("change",function(){var e;d3.selectAll("#select_bib_sort option").each(function(){if(this.selected){e=this.value}});view.dfb().set_view({type:"bib",param:e.split("_")})});d3.select("select#select_bib_dir").on("change",function(){var e;d3.selectAll("#select_bib_dir option").each(function(){if(this.selected){e=this.value}});view.dfb().set_view({type:"bib",param:[i.major,i.minor,e]})});d3.select("a#bib_sort_dir").attr("href",view.dfb().view_link({type:"bib",param:[i.major,i.minor,i.dir==="up"?"down":"up"]}));d3.select("#bib_headings a.top_link").on("click",function(){d3.event.preventDefault();view.scroll_top()});t=d3.select("#bib_view #bib_headings ul").selectAll("li").data(e,function(e){return e.key});t.enter().append("li").append("a");t.exit().remove();view.bib.major_keys.forEach(function(e){t.classed(e,i.major===e)});t.selectAll("a").attr("href",function(e){return"#"+view.bib.id(e.heading)}).on("click",function(e){d3.event.preventDefault();d3.select("#"+view.bib.id(e.heading)).node().scrollIntoView()}).text(function(e){return e.heading_display||e.heading});t.order();view.bib.render({ordering:e,citations:i.citations,major:i.major});return true};view.bib.render=function(t){var e,i,n;view.loading(true);e=d3.select("#bib_main").selectAll("div.section").data(t.ordering,function(e){return e.key});i=e.enter().append("div").classed("section",true).attr("id",function(e){return view.bib.id(e.heading)});i.append("h2");e.selectAll("h2").text(function(e){return e.heading_display||e.heading});i.append("ul");e.exit().remove();e.order();n=e.select("ul").selectAll("li").data(function(e){return e.docs});n.enter().append("li").append("a");n.exit().remove();n.order();n.selectAll("a").html(function(e){return t.citations.get(e)}).attr("href",function(e){return view.dfb().view_link({type:"doc",param:e})});view.loading("false")};view.bib.id=function(e){return"bib_"+String(e).replace(/\W/g,"_")};view.bib.dropdown=function(e){var t=d3.select("select#select_bib_sort").selectAll("option").data(e);t.enter().append("option");t.exit().remove();t.attr("id",function(e){return"sort_"+e[0]}).property("value",function(e){return e[0]}).text(function(e){return e[1]});view.bib.major_keys=d3.set(e.map(function(e){return e[0].split("_")[0]}))};"use strict";view.doc=function(i){var e=d3.select("div#doc_view"),t=i.total_tokens,n=i.topics,r,o;d3.select("#doc_view_main").classed("hidden",false);e.select("h2#doc_header").html(i.citation);e.select("#doc_remark .token_count").text(i.total_tokens);e.select("#doc_remark a.url").attr("href",i.url);r=e.select("table#doc_topics tbody").selectAll("tr").data(n.map(function(e,t){return{topic:i.ids[t],weight:e.weight,label:i.labels[t],words:i.words[t]}}));o=r.enter().append("tr");r.exit().remove();r.on("click",function(e){view.dfb().set_view({type:"topic",param:e.topic})});o.append("td").append("a").classed("topic_name",true).append("span").classed("name",true);r.select("a.topic_name").attr("href",function(e){return view.dfb().view_link({type:"topic",param:e.topic})}).select("span.name").text(function(e){return e.label});o.append("td").append("a").classed("topic_words",true).append("span").classed("words",true);r.select("a.topic_words").attr("href",function(e){return view.dfb().view_link({type:"topic",param:e.topic})}).select("span.words").text(function(e){return e.words.reduce(function(e,t){return e+" "+t.word},"")});view.weight_tds({sel:r,enter:o,w:function(e){return e.weight/t},frac:function(e){return d3.format(VIS.percent_format)(e.weight/t)},raw:i.proper?undefined:function(e){return e.weight}})};"use strict";view.model=function(){return true};"use strict";view.model.conditional=function(e){var t=e.streamgraph&&e.condition_type!=="ordinal",i=this.conditional.data;if(!i||i.signature!==e.signature||i.streamgraph!==e.streamgraph){i=view.model.stacked_series({keys:e.key.range,xs:e.key.range.map(e.key.invert),totals:e.conditional_totals,topics:e.topics,streamgraph:t});i.streamgraph=t;i.signature=e.signature;this.conditional.data=i}view.model.conditional_plot({condition_type:e.condition_type,condition_name:e.condition_name,data:i[e.raw?"raw":"frac"],domain_x:i.domain_x,domain_y:i[e.raw?"domain_raw":"domain_frac"],order:i.order,spec:VIS.model_view.conditional,raw:e.raw,selector:"#model_view_conditional"});d3.selectAll("#conditional_choice li").classed("active",false);d3.select(e.raw?"#nav_model_conditional_raw":"#nav_model_conditional_frac").classed("active",true)};view.model.conditional_plot=function(p){var m=p.spec,e,w,_,t,i,n,r,o,a,d,s=false,c,l,u,f,v,h,g,y;m.w=d3.select(p.selector).node().clientWidth||m.w;m.w-=m.m.left+m.m.right;m.h=Math.floor(m.w/m.aspect);m.h-=m.m.top+m.m.bottom;e=d3.select(p.selector).selectAll("svg").data([1]);e.enter().call(view.append_plot);e=view.setup_plot(e,m);a=e.selectAll("rect.bg").data([1]).enter().append("rect").classed("bg",true);a.attr("width",m.w).attr("height",m.h).classed("bg",true);d=d3.select("#model_conditional_clip");if(d.size()===0){d=d3.select("#model_view_conditional svg").append("clipPath").attr("id","model_conditional_clip");d.append("rect").attr("x",0).attr("y",0).attr("width",m.w).attr("height",m.h)}d3.select("#model_conditional_clip rect").transition().duration(1e3).attr("width",m.w).attr("height",m.h);o=function(){var n=d3.scale.category20(),r=[];p.order.forEach(function(e,t){r[e]=t});return function(e,t){var i=n(r[e]%20);return t?d3.hsl(i).brighter(.5).toString():i}}();if(p.condition_type==="ordinal"){w=d3.scale.ordinal().domain(p.domain_x).rangeRoundBands([0,m.w],m.ordinal.bar);c="g"}else{w=p.condition_type==="time"?d3.time.scale.utc():d3.scale.linear();w.domain(p.domain_x).range([0,m.w]);c="path"}_=d3.scale.linear().domain(p.domain_y).range([m.h,0]).nice();t=d3.svg.axis().scale(w).orient("bottom");n=e.selectAll("g.axis").data([1]);n.enter().append("g").classed("axis",true).classed("x",true).attr("transform","translate(0,"+m.h+")");n.attr("transform","translate(0,"+m.h+")").call(t);i=e.selectAll("text.axis_label").data([1]);i.enter().append("text");i.classed("axis_label",true).attr("x",m.w/2).attr("y",m.h+m.m.bottom).attr("text-anchor","middle").text(p.condition_name);e.selectAll("g.marks_group").data([0]).enter().append("g").classed("marks_group",true);u=e.selectAll(c==="path"?"g.topic_area":"path.topic_area");u.transition().duration(1e3).style("opacity",0).remove();l=e.select("g.marks_group").selectAll(c+".topic_area").data(p.data,function(e){return e.id});s=u.size()===0&&l.size()===0;l.enter().append(c).classed("topic_area",true).attr("clip-path","url(#model_conditional_clip)").style("fill",function(e){return o(e.t)}).style("opacity",s?1:0).on("mouseover",function(e){var t=e.label;d3.select(this).style("fill",o(e.t,true));if(p.spec.words>0){t+=": ";t+=e.words.join(" ")}view.tooltip().text(t);view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this).style("fill",o(e.t));view.tooltip().hide()}).on("click",function(e){if(!d3.event.shiftKey){view.dfb().set_view({type:"topic",param:e.id})}});l.exit().remove();if(c==="path"){r=d3.svg.area().x(function(e){return w(e.x)}).y0(function(e){return _(e.y0)}).y1(function(e){return _(e.y0+e.y)});f=function(e){e.attr("d",function(e){return r(e.values)}).transition().duration(1e3).style("opacity",1)}}else{v=l.selectAll("rect").data(function(e){return e.values});v.enter().append("rect");v.exit().remove();f=function(e){e.selectAll("rect").attr("x",function(e){return w(e.x)}).attr("y",function(e){return _(e.y0+e.y)}).attr("width",w.rangeBand()).attr("height",function(e){return _(e.y0)-_(e.y0+e.y)});e.transition().duration(1e3).style("opacity",1)}}e.selectAll("g.labels_group").data([0]).enter().append("g").classed("labels_group",true);h=e.select("g.labels_group").selectAll("text.layer_label").data(p.data,function(e){return e.id});h.enter().append("text").classed("layer_label",true).style("opacity",s?1:0).attr("clip-path","url(#model_conditional_clip)");h.exit().remove();g=function(e){var t,i,n,r,o,a=[],d=[],s=w.domain()[0],c=w.domain()[1],l=_.domain()[0],u=_.domain()[1],f=_(0);for(t=0;t<p.data.length;t+=1){n=p.data[t].t;a[n]=false;r=p.data[t].values;for(i=0,o=0;i<r.length;i+=1){if(r[i].x>=s&&r[i].x<=c&&r[i].y0+r[i].y>=l&&r[i].y0+r[i].y<=u){if(r[i].y>o&&f-_(r[i].y)>m.label_threshold){a[n]=true;d[n]=i;o=r[i].y}}}}e.transition().duration(1e3).style("opacity",function(e){return a[e.t]?1:0});e.filter(function(e){return a[e.t]}).attr("x",function(e){return w(e.values[d[e.t]].x)}).attr("y",function(e){return _(e.values[d[e.t]].y0+e.values[d[e.t]].y/2)}).text(function(e){var t=e.label;if(m.label_words>0){t+=": ";t+=e.words.slice(0,m.label_words).join(" ")}return t})};if(s){l.call(f);h.call(g)}else{l.transition().duration(1e3).call(f);h.transition().duration(1e3).call(g)}y=d3.behavior.zoom();if(p.condition_type!=="ordinal"){y.x(w)}y.y(_).scaleExtent([1,5]).on("zoom",function(){if(view.model.conditional.zoom_transition){l.transition().duration(1e3).call(f);h.transition().duration(1e3).call(g);e.select("g.x.axis").transition().duration(1e3).call(t);view.model.conditional.zoom_transition=false}else{l.call(f);h.call(g);e.select("g.x.axis").call(t)}});d3.select("button#reset_zoom").on("click",function(){view.model.conditional.zoom_transition=true;y.translate([0,0]).scale(1).event(e)});y(e);return true};view.model.stacked_series=function(n){var e,t,i,r={};e=n.topics.map(function(i){var e={t:i.t,words:i.words,label:i.label,id:i.id};e.values=n.keys.map(function(e,t){return{key:e,x:n.xs[t],y:i.wts.get(e)||0}});return e});t=d3.layout.stack().values(function(e){return e.values});if(n.streamgraph){t.offset("wiggle")}t.order("inside-out");r.frac=t(e);r.order=t.order()(e.map(function(e){return e.values.map(function(e){return[e.x,e.y]})}));t.order(function(e){return r.order});r.raw=t(e.map(function(e){return{t:e.t,words:e.words,label:e.label,values:e.values.map(function(e){return{x:e.x,y:e.y*(n.totals.get(e.key)||0)}})}}));i=function(e){return[0,d3.max(e.map(function(e){return d3.max(e.values,function(e){return e.y0+e.y})}))]};r.domain_x=d3.extent(n.xs);r.domain_frac=i(r.frac);r.domain_raw=i(r.raw);return r};"use strict";view.model.list=function(i){var e,t,n,r=d3.sum(i.sums),o,a,d,s;s=utils.clone(VIS.model_view.list.spark);s.time.step=VIS.condition.spec;d3.select("th#model_view_list_condition a").text(i.type==="time"?"over time":"by "+i.condition_name);e=d3.select("#model_view_list table tbody").selectAll("tr").data(i.data.map(function(e,t){return{t:t,data:e,label:i.labels[t],id:i.ids[t],hidden:!!i.topic_hidden[t],words:i.words[t],sum:i.sums[t]}}),function(e){return e.id});t=e.enter().append("tr");e.exit().remove();e.on("click",function(e){view.dfb().set_view({type:"topic",param:e.id})});e.classed("hidden_topic",function(e){return e.hidden});t.append("td").append("a").classed("topic_name",true);e.select("a.topic_name").attr("href",function(e){return view.dfb().view_link({type:"topic",param:e.id})}).text(function(e){return e.label});t.append("td").append("div").classed("spark",true).call(view.append_plot);e.select("td div.spark svg").call(view.setup_plot,s);e.select("td div.spark svg > g").each(function(e){view.topic.conditional_barplot({t:e.id,data:e.data,key:i.key,type:i.type,axes:false,clickable:false,transition:false,svg:d3.select(this),spec:s})});t.append("td").append("a").classed("topic_words",true);e.select("a.topic_words").attr("href",function(e){return view.dfb().view_link({type:"topic",param:e.id})});e.selectAll("td a.topic_words").text(function(e){return e.words.reduce(function(e,t){return e+" "+t.word},"")});n=d3.max(i.sums);view.weight_tds({sel:e,enter:t,w:function(e){return e.sum/n},frac:function(e){return d3.format(VIS.percent_format)(e.sum/r)}});if(i.sort==="words"){o=i.words.map(function(e){return e.reduce(function(e,t){return e+" "+t.word},"")})}else if(i.sort==="frac"){o=i.sums.map(function(e){return-e/r})}else if(i.sort==="condition"){o=i.data.map(function(e){var i,n=0;e.forEach(function(e,t){if(t>n){i=e;n=t}});return i})}else{o=i.labels.map(view.topic.sort_name)}if(i.dir==="down"){a=function(e,t){return d3.descending(o[e.t],o[t.t])||d3.descending(e.t,t.t)}}else{a=function(e,t){return d3.ascending(o[e.t],o[t.t])||d3.ascending(e.t,t.t)}}e.sort(a);d=function(e){var t={type:"model",param:e.split("_").slice(2)};if(e.match(i.sort)){t.param.push(i.dir==="down"?"up":"down")}return t};d3.selectAll("#model_view_list th.sort").classed("active",function(){return!!this.id.match(i.sort)}).on("click",function(){view.dfb().set_view(d(this.id))}).select("a").attr("href",function(){return view.dfb().view_link(d(this.parentElement.id))});return true};"use strict";view.model.plot=function(e){var t,d,i,n,r,o,a,s,c,l,u,f,p,m,w,_,v,h,g=e.topics,y=e.topics.length,b={};b.w=d3.select("#model_view").node().clientWidth||VIS.model_view.plot.w;b.w=Math.max(b.w,VIS.model_view.plot.w);b.h=Math.floor(b.w/VIS.model_view.plot.aspect);b.m={left:0,right:0,top:0,bottom:0};t=d3.select("#model_view_plot").selectAll("svg").data([1]);t.enter().call(view.append_plot);t=view.setup_plot(t,b);i=Math.floor(b.w/(2.1*Math.sqrt(VIS.model_view.plot.aspect*y)));d=i*1.8;n=1.1*i;r=t.selectAll("rect.bg").data([1]);r.enter().append("rect").classed("bg",true);r.attr("width",b.w);r.attr("height",b.h);if(e.type==="scaled"){g.forEach(function(e){e.x=e.scaled[0];e.y=e.scaled[1]})}else{g.forEach(function(e,t){g[t].sort_key=view.topic.sort_name(e.label)});g=g.sort(function(e,t){return d3.ascending(e.sort_key,t.sort_key)});view.model.grid_coords({n:y,cols:VIS.model_view.plot.cols||Math.floor(Math.sqrt(VIS.model_view.plot.aspect*y)),rows:VIS.model_view.plot.rows,indents:VIS.model_view.plot.indents}).forEach(function(e,t){g[t].x=e.x;g[t].y=e.y})}o=d3.extent(g,function(e){return e.x});a=d3.extent(g,function(e){return e.y});s=d3.scale.linear().domain(o).range([n,b.w-n]);c=d3.scale.linear().domain(a).range([b.h-n,n]);l=d3.scale.sqrt().domain([0,1]).range(VIS.model_view.plot.size_range);u=d3.scale.linear().domain([0,d3.max(g,function(e){return e.total})]).range([0,VIS.model_view.plot.stroke_range]);f=t.selectAll("g.topic").data(g,function(e){return e.id});p=f.enter().append("g").classed("topic",true).style("opacity",f.enter().size()===f.size()?1:0);m=f.exit().empty()?0:1e3;f.exit().transition().duration(m).style("opacity",0).remove();p.append("clipPath").attr("id",function(e){return"clip_circ"+e.t}).append("circle").attr({cx:0,cy:0});p.append("circle").attr("cx",0).attr("cy",0).classed("topic_cloud",true).attr("stroke-width",function(e){return u(e.total)}).on("click",function(e){if(!d3.event.shiftKey){view.dfb().set_view({type:"topic",param:e.id})}}).on("mouseover",function(i){f.sort(function(e,t){if(e.t===t.t){return 0}if(e.t===i.t){return 1}if(t.t===i.t){return-1}return d3.ascending(e.t,t.t)}).order()}).on("mouseout",function(){f.sort(function(e,t){return d3.ascending(e.t,t.t)}).order()});w=f.selectAll("text.topic_word").data(function(t){var i=t.words[0].weight,e=t.words.map(function(e){return{text:e.word,size:Math.floor(l(e.weight/i)),t:t.t}}),n=0,r=0,o=false,a;for(a=0;a<e.length;a+=1,o=!o){if(o){e[a].y=n;n-=e[a].size}else{r+=e[a].size;e[a].y=r}if(n-d/2<e[a].size&&r>d/2){break}}return e.slice(0,a)},function(e){return e.text});w.enter().append("text").classed("topic_word",true).attr("clip-path",function(e){return"url(#"+"clip_circ"+e.t}).style("font-size","1px");w.exit().transition().duration(1e3).style("opacity",0).remove();w.text(function(e){return e.text}).attr("x",0).attr("y",function(e){return e.y});_=f.selectAll("text.topic_name").data(function(e){var i=e.label.split(" ");return i.map(function(e,t){return{w:e,y:VIS.model_view.plot.name_size*(t-(i.length-1)/2)}})});_.enter().append("text").classed("topic_name",true);_.exit().remove();_.attr("x",0).attr("y",function(e){return e.y}).text(function(e){return e.w}).style("font-size",VIS.model_view.plot.name_size+"px").classed("merged_topic_sep",function(e){return e.w==="or"});v=function(e){var t="translate("+s(e.x);t+=","+c(e.y)+")";return t};p.attr("transform",v).selectAll("circle").attr("r",i);p.selectAll("text.topic_word").style("font-size",function(e){return e.size+"px"});f.transition().delay(m).duration(1e3).attr("transform",v).each(function(){d3.select(this).selectAll("circle").transition().attr("r",i)}).transition().duration(1e3).style("opacity",1);w.transition().delay(1e3).duration(1e3).style("font-size",function(e){return e.size+"px"});w.exit().transition().duration(1e3).style("font-size","1px").remove();if(e.type==="scaled"){h=d3.behavior.zoom().x(s).y(c).scaleExtent([1,10]).on("zoom",function(){if(view.model.plot.zoom_transition){f.transition().duration(1e3).attr("transform",v);view.model.plot.zoom_transition=false}else{f.attr("transform",v)}});d3.select("button#reset_zoom").on("click",function(){view.model.plot.zoom_transition=true;h.translate([0,0]).scale(1).event(t)});h(t)}else{t.on(".zoom",null)}};view.model.grid_coords=function(e){var t=e.cols||Math.floor(Math.sqrt(e.n)),i=Math.round(e.n/t),n=e.n-i*t,r=d3.ascending(n,0),o,a,d,s,c,l=[];d=Math.sqrt(3)/2;if(e.rows&&d3.sum(e.rows)===e.n){o=e.rows;i=e.rows.length}if(o===undefined){o=[];for(s=r===1?0:1;s<i;s+=2){o[s]=t;if(Math.abs(n)>0){o[s]+=r;n-=r}}for(s=r===1?1:0;s<i;s+=2){o[s]=t;if(Math.abs(n)>0){o[s]+=r;n-=r}}if(r===-1){o.reverse()}}if(e.indents&&e.indents.length===i){a=e.indents}if(a===undefined){a=d3.range(i).map(function(e){return e%2===0?0:.5})}for(s=0;s<i;s+=1){for(c=0;c<o[s];c+=1){l.push({x:c+.5+a[s],y:(i-s)*d+.5})}}return l};"use strict";view.settings=function(e){var t;t=d3.select("#settings_modal");t.select("#n_words_list input").property("min",1).property("max",e.max_words).property("value",e.overview_words).on("change",function(){view.dfb().update_settings({overview_words:this.valueAsNumber})});t.select("#n_words_topic input").property("min",1).property("max",e.max_words).property("value",e.topic_view.words).on("change",function(){view.dfb().update_settings({topic_view:{words:this.valueAsNumber}})});t.select("#n_topic_docs input").property("min",1).property("max",e.max_docs).property("value",e.topic_view.docs).on("change",function(){view.dfb().update_settings({topic_view:{docs:this.valueAsNumber}})});t.select("#reveal_hidden").classed("hidden",VIS.hidden_topics.length===0).select("input").property("checked",e.show_hidden_topics===true).on("change",function(){view.dfb().update_settings({show_hidden_topics:this.checked})});t.select("#conditional_streamgraph").classed("hidden",e.condition_type==="ordinal").select("input").property("checked",!!e.model_view.conditional.streamgraph).on("change",function(){view.dfb().update_settings({model_view:{conditional:{streamgraph:this.checked}}})})};"use strict";view.topic=function(e){var t=d3.select("div#topic_view");t.select("#topic_header").text(e.label)};view.topic.words=function(t){var e,i;e=d3.select("table#topic_words tbody").selectAll("tr").data(t);i=e.enter().append("tr");e.exit().remove();e.on("click",function(e){view.dfb().set_view({type:"word",param:e.word})});i.append("td").classed("topic_word",true).append("a");e.select("td.topic_word a").attr("href",function(e){return view.dfb().view_link({type:"word",param:+e.word})}).text(function(e){return e.word});view.weight_tds({sel:e,enter:i,w:function(e){return e.weight/t[0].weight}})};view.topic.docs=function(i){var e,t,n,r=i.docs;if(i.condition!==undefined){e=": ";if(i.type!=="time"){e+=i.condition_name+" "}e+=i.key.display(i.condition);d3.select("#topic_condition_clear").classed("disabled",false).on("click",function(){d3.select(".selected_condition").classed("selected_condition",false);view.dfb().set_view({type:"topic",param:i.t})}).classed("hidden",false)}else{e="";d3.select("#topic_condition_clear").classed("disabled",true)}d3.selectAll("#topic_docs span.topic_condition").text(e);if(r===undefined||r.length===0){d3.selectAll("#topic_docs .none").classed("hidden",false);d3.select("#topic_docs table").classed("hidden",true);return true}d3.selectAll("#topic_docs .none").classed("hidden",true);d3.select("#topic_docs table").classed("hidden",false);t=d3.select("#topic_docs tbody").selectAll("tr").data(r);n=t.enter().append("tr");t.exit().remove();n.append("td").append("a").classed("citation",true);t.select("a.citation").html(function(e,t){return i.citations[t]});t.on("click",function(e,t){view.dfb().set_view({type:"doc",param:i.doc_ids[t]})});view.weight_tds({sel:t,enter:n,w:function(e){return e.frac},frac:function(e){return d3.format(VIS.percent_format)(e.frac)},raw:i.proper?undefined:function(e){return e.weight}})};view.topic.conditional=function(e){var t=utils.clone(VIS.topic_view);t.w=d3.select("#topic_conditional").node().clientWidth||t.w;t.w=Math.max(t.w,VIS.topic_view.w);t.w-=t.m.left+t.m.right;t.h=Math.floor(t.w/VIS.topic_view.aspect)-t.m.top-t.m.bottom;t.time.step=VIS.condition.spec;e.svg=d3.select("div#topic_plot").selectAll("svg").data([1]);e.svg.enter().call(view.append_plot);e.svg=view.setup_plot(e.svg,t);e.axes=true;e.clickable=true;e.spec=t;view.topic.conditional_barplot(e)};view.topic.conditional_barplot=function(n){var e,t,i,r,o,a,d,s,c,l,u,f,p,m,w,_=n.transition?n.spec.tx_duration:0,v=n.svg,h=n.spec;e=n.data.keys().sort().map(function(e){return{key:e,x:n.key.invert(e),y:n.data.get(e)}});if(n.type==="continuous"){e[0].w=Infinity;t=e.reduce(function(e,t){return{x:t.x,w:Math.min(t.x-e.x,e.w)}}).w;delete e[0].w;d=d3.scale.linear().domain([e[0].x,e[e.length-1].x+t*h.continuous.bar.w]).range([0,h.w]);i=d(e[0].x+t*h.continuous.bar.w)-d(e[0].x);o=-i/2;r=d(e[0].x+t)-d(e[0].x);a=-r/2;m=r/2}else if(n.type==="time"){d=d3.time.scale.utc().domain([e[0].x,d3.time[h.time.bar.unit].utc.offset(e[e.length-1].x,h.time.bar.w)]).range([0,h.w]);i=d(d3.time[h.time.bar.unit].utc.offset(e[0].x,h.time.bar.w))-d(e[0].x);o=-i/2;r=d(d3.time[h.time.step.unit].utc.offset(e[0].x,h.time.step.n))-d(e[0].x);a=-r/2;m=r/2}else{d=d3.scale.ordinal().domain(e.map(function(e){return e.x})).rangeRoundBands([0,h.w],h.ordinal.bar.w,h.ordinal.bar.w);i=d.rangeBand();o=0;r=d(e[1].x)-d(e[0].x);a=(i-r)/2;m=3}s=d3.scale.linear().domain([0,d3.max(e,function(e){return e.y})]).range([h.h,0]).nice();if(n.axes){f=v.selectAll("g.axis").data(["x","y"]);f.enter().append("g").classed("axis",true).classed("x",function(e){return e==="x"}).classed("y",function(e){return e==="y"}).attr("transform",function(e){return e==="x"?"translate(0,"+h.h+")":"translate(-5, 0)"});f.transition().duration(_).attr("transform",function(e){return e==="x"?"translate(0,"+h.h+")":undefined}).each(function(e){var t=d3.select(this),i=d3.svg.axis().scale(e==="x"?d:s).orient(e==="x"?"bottom":"left");if(e==="x"){if(n.type==="time"){if(h.time.ticks.unit){i.ticks(d3.time[h.time.ticks.unit].utc,h.time.ticks.n)}else if(typeof h.time.ticks==="number"){i.ticks(h.time.ticks)}}else{i.ticks(h[n.type].ticks)}}else{i.tickSize(-h.w).outerTickSize(0).tickFormat(d3.format(VIS.percent_format)).tickPadding(m).ticks(h.ticks_y)}t.call(i);if(e==="y"){t.selectAll("g").filter(function(e){return e>0}).classed("minor",true)}});p=v.selectAll("text.axis_label").data([1]);p.enter().append("text");p.classed("axis_label",true).attr("x",h.w/2).attr("y",h.h+h.m.bottom).attr("text-anchor","middle").text(n.condition_name)}c=v.selectAll("g.topic_proportion").data(e,function(e){return e.key});l=c.enter().append("g").classed("topic_proportion",true).attr("transform",function(e){return"translate("+d(e.x)+",0)"});c.exit().remove();if(n.clickable){l.append("rect").classed("interact",true);u=c.select("rect.interact");u.transition().duration(_).attr("x",a).attr("y",0).attr("width",r).attr("height",h.h)}c.classed("selected_condition",function(e){return e.key===n.condition});l.append("rect").classed("display",true).style("fill",n.color).style("stroke",n.color);c.transition().duration(_).attr("transform",function(e){return"translate("+d(e.x)+",0)"}).select("rect.display").attr("x",o).attr("y",function(e){return s(e.y)}).attr("width",i).attr("height",function(e){return h.h-s(e.y)});if(n.clickable){c.on("mouseover",function(e){d3.select(this).classed("hover",true)}).on("mouseout",function(e){d3.select(this).classed("hover",false)});w=function(e){return n.key.display(e.key)};u.on("mouseover",function(e){var t=d3.select(this.parentNode);t.select(".display").classed("hover",true);view.tooltip().text(w(e));view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this.parentNode).select(".display").classed("hover",false);view.tooltip().hide()}).on("click",function(e){if(d3.select(this.parentNode).classed("selected_condition")){d3.select(this.parentNode).classed("selected_condition",false);view.tooltip().text(w(e));view.dfb().set_view({type:"topic",param:n.t})}else{d3.selectAll(".selected_condition").classed("selected_condition",false);d3.select(this.parentNode).classed("selected_condition",true);view.tooltip().text(w(e));view.dfb().set_view({type:"topic",param:[n.t,e.key]})}})}};view.topic.sort_name=function(e){var t=e.match(/^Topic\s(\d+)$/);if(t){return"zzz"+d3.format("05d")(+t[1])}return e.replace(/^(the|a|an) /i,"").toLowerCase()};view.topic.dropdown=function(i){var e;d3.select("ul#topic_dropdown").selectAll("li.loading_message").remove();e=d3.select("ul#topic_dropdown").selectAll("li").data(i.topics,function(e){return e.topic});e.enter().append("li").append("a");e.exit().remove();e.select("a").text(function(e){var t=e.words.slice(0,i.overview_words).map(function(e){return e.word}).join(" ");return e.label+": "+t}).attr("href",function(e){return view.dfb().view_link({type:"topic",param:e.id})});e.sort(function(e,t){return d3.ascending(view.topic.sort_name(e.label),view.topic.sort_name(t.label))});e.classed("hidden_topic",function(e){return e.hidden})};"use strict";view.word=function(e){var t=d3.select("div#word_view"),i=e.word,n=e.n,r,o,a,d,s,c,l,u,f,p,m,w,_,v=!e.updating,h;d3.select("form#word_view_form").on("submit",function(){d3.event.preventDefault();var e=d3.select("input#word_input").property("value").toLowerCase();view.dfb().set_view({type:"word",param:e})});if(e.word===undefined){return}t.selectAll("#word_view span.word").text(i);t.selectAll("#word_view .none").classed("hidden",e.topics.length!==0);t.select("table#word_topics").classed("hidden",e.topics.length===0);t.select("#word_view_explainer").classed("hidden",e.topics.length===0);r={m:VIS.word_view.m};r.w=d3.select("#main_container").node().clientWidth||VIS.word_view.w;r.w-=r.m.left+r.m.right;r.h=VIS.word_view.row_height*(e.topics.length+1);o=VIS.word_view.row_height;d=d3.select("#word_view_main").selectAll("svg").data([1]);d.enter().call(view.append_plot);d=view.setup_plot(d,r);a=Math.max(r.w,VIS.word_view.w);c=d3.scale.linear().domain([0,n]).range([0,a]);l=d3.scale.linear().domain([0,Math.max(1,e.topics.length-1)]).range([o,o*(Math.max(e.topics.length,1)+1)]);u=d3.scale.linear().domain([0,1]).range([0,o/2]);s=d3.select("#word_view_clip");if(s.size()===0){s=d3.select("#word_view svg").append("clipPath").attr("id","word_view_clip");s.append("rect")}s.select("rect").attr("x",-r.m.left).attr("y",-r.m.top).attr("width",r.w+r.m.left+r.m.right).attr("height",r.h+r.m.top+r.m.bottom);d.attr("clip-path","url(#word_view_clip)");f=d.selectAll("g.topic").data(e.topics,function(e){return e.id});f.transition().duration(1e3).attr("transform",function(e,t){return"translate(0,"+l(t)+")"});p=f.enter().append("g").classed("topic",true).attr("transform",function(e,t){return"translate(0,"+l(t)+")"}).style("opacity",v?1:0);d3.transition().duration(1e3).ease("linear").each("end",function(){f.style("opacity",1)});f.exit().transition().duration(2e3).attr("transform","translate(0,"+o*(n+f.exit().size())+")").remove();p.append("rect").classed("interact",true).attr({x:-r.m.left,y:-o,width:r.m.left,height:o}).on("click",function(e,t){view.dfb().set_view({type:"topic",param:e.id})});m=f.selectAll("text.topic").data(function(e){var i=e.label.split(" ");return i.map(function(e,t){return{word:e,y:-o/2-(i.length/2-t-1)*VIS.word_view.topic_label_leading}})},function(e,t){return e.word+String(t)});m.enter().append("text").classed("topic",true);m.exit().remove();m.attr("x",-VIS.word_view.topic_label_padding).attr("y",function(e){return e.y}).text(function(e){return e.word}).classed("merged_topic_sep",function(e){return e.word==="or"});w=f.selectAll("g.word").data(function(e){var t=e.words[0].weight;return e.words.map(function(e){return{word:e.word,weight:e.weight/t}})},function(e){return e.word});_=w.enter().append("g").classed("word",true);_.append("text").attr("transform","rotate(-45)");_.append("rect").classed("proportion",true).attr({x:0,y:0}).attr("width",a/(2*n)).attr("height",function(e){return u(e.weight)});w.selectAll("text").text(function(e){return e.word});w.selectAll("text, rect").on("click",function(e){view.dfb().set_view({type:"word",param:e.word})}).on("mouseover",function(){d3.select(this.parentNode).classed("hover",true)}).on("mouseout",function(){d3.select(this.parentNode).classed("hover",false)});w.classed("selected_word",function(e){return e.word===i});_.attr("transform",function(e,t){return"translate("+c(t)+",-"+o/2+")"}).attr("opacity",v?0:1);h=w.transition().duration(2e3).attr("transform",function(e,t){return"translate("+c(t)+",-"+o/2+")"}).attr("opacity",1);h.selectAll("text").attr("x",a/(4*n));h.selectAll("rect").attr("width",a/(2*n)).attr("height",function(e){return u(e.weight)});w.exit().transition().delay(1e3).remove();return true};"use strict";view.words=function(e){var t=d3.select("ul#vocab_list").selectAll("li").data(e);t.exit().remove();t.enter().append("li").append("a");t.select("a").text(function(e){return e}).attr("href",function(e){return"#/word/"+e});return true};"use strict";var dfb=function(e){var a=e||{},o={},i,d,r,s,c,l,u,t,f,n,p,m,w,_,v,h,g,y,b,x,k,A,S,I;a.ms=d3.map();a.model_vis=d3.map();if(view.dfb()===undefined){view.dfb(o)}else{view.error("view.dfb already defined: dfb() called more than once?")}a.views=d3.map();a.last={bib:{},model_list:{}};a.cache={};a.settings={overview_words:0,show_hidden_topics:false,topic_view:{words:0,docs:0},model_view:{conditional:{streamgraph:true}}};a.shared={models:d3.map(),meta:d3.map(),model_key:function(e){return e.dt+">>>"+e.tw+">>>"+e.topic_scaled}};a.views.set("topic",function(t,i){var e,n,r;if(!a.m.ready("meta")||!a.m.ready("dt")||!a.m.ready("tw")){view.loading(true);return true}n=a.m.topic_index(t);if(!isFinite(n)||n<0||n>=a.m.n()){d3.select("#topic_view_help").classed("hidden",false);d3.select("#topic_view_main").classed("hidden",true);view.loading(false);return true}e=utils.shorten(a.m.topic_words(n),a.settings.topic_view.words);view.topic({t:n,words:e,label:a.m.topic_label(n)});d3.select("#topic_view_help").classed("hidden",true);d3.select("#topic_view_main").classed("hidden",false);view.topic.words(e);view.calculating("#topic_docs",true);if(!a.condition||!a.m.ready("meta_"+a.condition.field)){view.loading(true);return true}a.m.topic_conditional(n,a.condition.field,function(e){view.topic.conditional({t:t,condition:e.has(i)?i:undefined,type:a.condition.type,condition_name:a.condition.name,data:e,key:a.m.meta_condition(a.condition.field),transition:a.updating})});r=function(e){var t=e.map(function(e){return a.m.meta().doc_id(e.doc)});view.calculating("#topic_docs",false);view.topic.docs({t:a.m.topic_id(n),docs:e,doc_ids:t,citations:a.m.meta().doc(t).map(function(e){return a.m.bib().citation(e)}),condition:i,type:a.condition.type,condition_name:a.condition.name,key:a.m.meta_condition(a.condition.field),proper:a.proper})};if(i===undefined){a.m.topic_docs(n,a.settings.topic_view.docs,r)}else{a.m.topic_docs_conditional(n,a.condition.field,i,a.settings.topic_view.docs,r)}view.loading(false);return i===undefined?[t]:[t,i]});a.views.set("word",function(e){var t=d3.select("div#word_view"),i,n=e,r,o=0;if(!a.m.ready("tw")){view.loading(true);return true}view.loading(false);if(n){t.select("#word_view_help").classed("hidden",true)}else{t.select("#word_view_help").classed("hidden",false);if(a.last.word){n=a.last.word;i=f({type:"word",param:n});t.select("a#last_word").attr("href",i).text(document.URL.replace(/#.*$/,"")+i);t.select("#last_word_help").classed("hidden",false)}else{t.select("#word_view_main").classed("hidden",true);view.word({word:undefined});return true}}t.select("#word_view_main").classed("hidden",false);a.updating=n===a.last.word;a.last.word=n;r=a.m.word_topics(n).filter(function(e){return!w(e.topic)});if(r.length>0){o=1+d3.max(r,function(e){return e.rank});o=d3.max(r,function(e){return a.m.topic_words(e.topic,o).length})}o=Math.max(VIS.word_view.n_min,o);view.word({word:n,topics:r.map(function(e){return{t:e.topic,id:a.m.topic_id(e.topic),label:a.m.topic_label(e.topic),rank:e.rank,words:a.m.topic_words(e.topic,o).slice(0,o)}}),n:o,n_topics:a.m.n(),updating:a.updating});return n?[n]:[]});a.views.set("words",function(){var e;if(!a.m.ready("tw")){view.loading(true);return true}view.loading(false);if(!a.settings.show_hidden_topics){e=d3.range(a.m.n()).filter(function(e){return!w(e)})}return view.words(a.m.vocab(e))});a.views.set("doc",function(e){var t=d3.select("div#doc_view"),i,n,r;if(!a.m.ready("meta")||!a.m.ready("dt")||!a.m.ready("tw")){view.loading(true);return true}i=a.m.meta().doc_index(e);view.loading(false);if(i===undefined){d3.select("#doc_view_help").classed("hidden",false);if(a.last.doc===undefined){d3.select("#doc_view_main").classed("hidden",true);return[]}i=a.m.meta().doc_index(a.last.doc);if(i===undefined){d3.select("#doc_view_main").classed("hidden",true);return[]}r=a.m.meta().doc(a.last.doc);n=f({type:"doc",param:a.last.doc});t.select("a#last_doc").attr("href",n).text(document.URL.replace(/#.*$/,"")+n);t.select("#last_doc_help").classed("hidden",false)}else{d3.select("#doc_view_help").classed("hidden",true);a.last.doc=e;r=a.m.meta().doc(e)}d3.select("#doc_view_main").classed("hidden",false);view.calculating("#doc_view",true);a.m.doc_topics(i,a.m.n(),function(e){var t=e.filter(function(e){return!w(e.topic)});view.calculating("#doc_view",false);view.doc({topics:t,citation:a.m.bib().citation(r),url:a.m.bib().url(r),total_tokens:d3.sum(t,function(e){return e.weight}),words:t.map(function(e){return a.m.topic_words(e.topic,a.settings.overview_words)}),labels:t.map(function(e){return a.m.topic_label(e.topic)}),ids:t.map(function(e){return a.m.topic_id(e.topic)}),proper:a.proper});m()});return[e]});a.views.set("bib",function(e,t,i){var n={major:e,minor:t,dir:i},r;if(!a.m.ready("meta")){view.loading(true);return true}n=a.m.bib().sort.validate(n);if(n.minor===undefined){if(n.major===undefined){n.minor=a.last.bib.minor||VIS.bib_view.minor}else{n.minor=VIS.bib_view.minor}}if(n.major===undefined){n.major=a.last.bib.major||VIS.bib_view.major}if(n.dir===undefined){n.dir=a.last.bib.dir||VIS.bib_view.dir}a.last.bib=n;r=a.m.bib().sort({major:n.major,minor:n.minor,dir:a.m.bib().sort.dir(n),docs:a.m.meta().doc(),doc_ids:a.m.meta().doc_id()});if(!a.cache.citations){a.cache.citations=d3.map();a.m.meta().doc().forEach(function(e,t){a.cache.citations.set(a.m.meta().doc_id(t),a.m.bib().citation(e))})}view.bib.dropdown(a.m.bib().sorting());view.bib({ordering:r,major:n.major,minor:n.minor,dir:n.dir,citations:a.cache.citations});view.loading(false);return[n.major,n.minor,n.dir]});a.views.set("about",function(){view.about({meta_info:a.meta_info});view.loading(false);return true});i=function(){var e={max_words:a.m.n_top_words(),max_docs:a.m.n_docs(),condition_type:a.condition.type};if(e.max_words===undefined||e.max_docs===undefined){return false}a.settings.overview_words=Math.min(e.max_words,a.settings.overview_words);a.settings.topic_view.words=Math.min(e.max_words,a.settings.topic_view.words);a.settings.topic_view.docs=Math.min(e.max_docs,a.settings.topic_view.docs);e=utils.deep_replace(e,a.settings);view.settings(e);$("#settings_modal").modal();return true};o.settings_modal=i;d=function(e){a.settings=utils.deep_replace(a.settings,e,true)};o.update_settings=d;a.views.set("model",function(e,t,i){var n=e||a.last.model||"grid";if(["grid","scaled","list","conditional"].indexOf(n)===-1){n="grid"}if(!a.m.ready("tw")||!a.m.ready("topic_scaled")){view.loading(true);return true}d3.selectAll("#nav_model li.active").classed("active",false);d3.select("#nav_model_"+n).classed("active",true);a.updating=a.updating&&n===a.last.model;if(!a.updating){d3.select("#model_view_plot").classed("hidden",true);d3.select("#model_view_list").classed("hidden",true);d3.select("#model_view_conditional").classed("hidden",true);d3.selectAll(".model_view_grid").classed("hidden",true);d3.selectAll(".model_view_scaled").classed("hidden",true);d3.selectAll(".model_view_list").classed("hidden",true);d3.selectAll(".model_view_conditional").classed("hidden",true)}d3.select("#model_view nav").classed("hidden",false);if(n==="list"){if(!a.m.ready("meta")||!a.m.ready("dt")||!a.condition||!a.m.ready("meta_"+a.condition.field)){view.loading(true);return true}r(t,i);d3.select("#model_view_list").classed("hidden",false)}else if(n==="conditional"){if(!a.m.ready("meta")||!a.m.ready("dt")||!a.condition||!a.m.ready("meta_"+a.condition.field)){view.loading(true);return true}c(t);d3.select("#model_view_conditional").classed("hidden",false)}else{if(!a.m.ready("topic_scaled")||!a.m.ready("dt")){view.loading(true);return true}if(n!=="scaled"||a.m.topic_scaled().length!==a.m.n()){n="grid"}s(n);d3.select("#model_view_plot").classed("hidden",false)}a.last.model=n;d3.selectAll(".model_view_"+n).classed("hidden",false);view.loading(false);return[n]});r=function(e,t){var i,n;view.calculating("#model_view_list",true);i=e||a.last.model_list.sort||"topic";n=t||(i===a.last.model_list.sort?a.last.model_list.dir:"up")||"up";a.last.model_list.sort=i;a.last.model_list.dir=n;a.m.topic_total(undefined,function(t){a.m.topic_conditional(undefined,a.condition.field,function(e){view.calculating("#model_view_list",false);view.model.list({data:e,condition_name:a.condition.name,type:a.condition.type,key:a.m.meta_condition(a.condition.field),sums:t,words:a.m.topic_words(undefined,a.settings.overview_words),sort:i,dir:n,labels:d3.range(a.m.n()).map(a.m.topic_label),ids:d3.range(a.m.n()).map(a.m.topic_id),topic_hidden:e.map(function(e){return w(e.t)})});m()})});return true};s=function(i){a.m.topic_total(undefined,function(t){var e=d3.range(a.m.n()).filter(function(e){return!w(e)});view.model.plot({type:i,topics:e.map(function(e){return{t:e,words:a.m.topic_words(e,VIS.model_view.plot.words),scaled:a.m.topic_scaled(e),total:t[e],label:a.m.topic_label(e),id:a.m.topic_id(e)}})})});return true};c=function(e){var i={key:a.m.meta_condition(a.condition.field),condition_type:a.condition.type,condition_name:a.condition.name,streamgraph:a.settings.model_view.conditional.streamgraph,signature:_()};i.raw=e?e==="raw":a.last.model_conditional;a.last.model_conditional=i.raw;view.calculating("#model_view_conditional",true);a.m.conditional_total(a.condition.field,undefined,function(t){a.m.topic_conditional(undefined,a.condition.field,function(e){i.conditional_totals=t;i.topics=e.map(function(e,t){return{t:t,wts:e,words:a.m.topic_words(t,VIS.model_view.conditional.words).map(function(e){return e.word}),label:a.m.topic_label(t),id:a.m.topic_id(t)}}).filter(function(e){return!w(e.t)});view.model.conditional(i);view.calculating("#model_view_conditional",false)})});return true};l=function(){var i=window.location.hash,e,t,n,r=false;if(a.aliases){a.aliases.forEach(function(e,t){i=i.split(e).join(t)})}e=p(i);if(!e){u(a.default_view);return}a.updating=false;if(a.models.length>1&&e.model){if(a.id&&a.id!==e.model){y(e.model)}}t=e.type;if(a.last.view){a.updating=t===a.last.view.type;if(!a.updating){d3.select("#"+a.last.view.type+"_view").classed("hidden",true)}}if(a.views.has(t)){r=a.views.get(t).apply(o,e.param)}if(r){n=Array.isArray(r)?r:[]}else if(a.last.view){t=a.last.view.type;n=a.last.view.param;a.views.get(t).apply(o,n)}else{u(a.default_view);return}view.update_annotations(t,n);if(!a.updating){view.scroll_top()}m();d3.select("#"+t+"_view").classed("hidden",false);d3.selectAll("#nav_main > li.active").classed("active",false);d3.select("li#nav_"+t).classed("active",true);d3.selectAll("#nav_main li:not(.active) > .nav").classed("hidden",true);d3.selectAll("#nav_main li.active > .nav").classed("hidden",false);a.last.view={type:t,param:n}};o.refresh=l;u=function(e){window.location.hash=t(e)};o.set_view=u;n=function(e){var t=utils.clone(a.last.view);t.model=e;u(t)};o.switch_model=n;f=function(e){return"#"+t(e)};o.view_link=f;t=function(e){var t="";if(a.models.length>1){e.model=e.model||a.id;t+="/"+e.model}if(!e.type){return t}t+="/"+e.type;if(e.param!==undefined){if(!Array.isArray(e.param)){e.param=[e.param]}if(e.param.length===0){return t}t+="/"+e.param.join("/")}return t};p=function(e){var t={},i;if(typeof e!=="string"){return undefined}i=e.split("/");if(i.shift()!=="#"){return undefined}if(a.models.length>1){t.model=i.shift();if(a.views.has(t.model)){i.unshift(t.model);t.model=undefined}}t.type=i.shift();t.param=i;if(t.type==="doc"&&t.param.length>1){t.param=[t.param.join("/")]}return t};m=function(e){var t=e===undefined?!a.settings.show_hidden_topics:e;d3.selectAll(".hidden_topic").classed("hidden",function(){return t})};w=function(e){if(a.settings.show_hidden_topics){return false}if(!a.cache.topic_hidden){if(!isFinite(a.m.n())){return false}a.cache.topic_hidden=d3.range(a.m.n()).map(function(e){return VIS.hidden_topics.indexOf(a.m.topic_id(e))!==-1})}return a.cache.topic_hidden[e]};_=function(){return a.id+(a.settings.show_hidden_topics?"_show":"_hide")};v=function(e){var t;window.onhashchange=function(){l()};$(window).resize(function(){if(t){window.clearTimeout(t)}t=window.setTimeout(function(){l();t=undefined},e)});d3.select("#nav_settings a").on("click",function(){d3.event.preventDefault();i()});$("#settings_modal").on("hide.bs.modal",function(){l()})};h=function(e){var t,i;a.default_view=p("#"+e);if(a.models.length>1&&!a.ms.has(a.default_view.model)){a.default_view.model=undefined}if(!a.views.has(a.default_view.type)){view.warning("Invalid VIS.default_view setting.");a.default_view.type="model"}t=p(window.location.hash);if(t&&t.model&&a.ms.has(t.model)){i=t.model}else{i=a.default_view.model||a.models[0].id}view.frame({title:a.title,models:a.models,id:i});return i};g=function(e,r){var o,t;if(e===undefined){return r("target undefined",undefined)}o=e.replace(/^.*\//,"");t=d3.select("#m__DATA__"+o.replace(/\//g,"_").replace(/\..*$/,""));if(!t.empty()){return r(undefined,JSON.parse(t.html()))}if(e.search(/\.zip$/)>0){return d3.xhr(e).responseType("arraybuffer").get(function(e,t){var i,n;if(t&&t.status===200&&t.response.byteLength){i=new JSZip(t.response);n=i.file(o.replace(/\.zip$/,"")).asText()}return r(e,n)})}return d3.text(e,function(e,t){return r(e,t)})};I=function(){g(VIS.files.info,function(e,t){var i,n,r;if(typeof t==="string"){i=JSON.parse(t)}else{view.warning("Unable to load model info from "+VIS.files.info)}a.title=i.title;a.meta_info=i.meta_info;a.models=i.models||[{id:"__SINGLE__"}];a.models.forEach(function(e){var t;if(a.views.has(e.id)||!!e.id.match(/[\/#]/)){view.warning("The model ID "+e.id+" is not compatible with dfr-browser. Please choose another.")}if(typeof e.id!=="string"){view.error("The ID is mising from a model specification in info.json is missing.")}t="data/";if(e.id!=="__SINGLE__"){t+=e.id+"/"}e.files=utils.deep_replace({info:t+"info.json",meta:t+"meta.csv.zip",dt:t+"dt.json.zip",tw:t+"tw.json",topic_scaled:t+"topic_scaled.csv"},e.files);r=a.shared.model_key(e.files);if(a.shared.models.get(r)){a.shared.models.get(r).push(e.id)}else{a.shared.models.set(r,[e.id])}r=e.files.meta;if(a.shared.meta.get(r)){a.shared.meta.get(r).push(e.id)}else{a.shared.meta.set(r,[e.id])}a.ms.set(e.id,undefined)});a.vis_template=utils.clone(VIS);a.vis_template=utils.deep_replace(a.vis_template,i.VIS);v(a.vis_template.resize_refresh_delay);n=h(a.vis_template.default_view);d(a.vis_template);a.aliases=d3.map(a.vis_template.aliases);if(a.models.length>1){y(n)}else{y(n,a.vis_template)}l()})};o.load=I;y=function(t,e){var i,n;if(!a.ms.has(t)){view.warning("Unknown model "+t);return false}if(a.m&&a.id===t){return true}if(e){i=e.files}else{i=a.models.find(function(e){return e.id===t}).files}if(a.ms.get(t)===undefined){n=a.shared.models.get(a.shared.model_key(i)).find(function(e){return a.ms.get(e)!==undefined});a.ms.set(t,n?a.ms.get(n):model())}a.m=a.ms.get(t);a.id=t;a.cache={};a.condition=undefined;b(i.info,e,function(){A(i.meta);x(i.dt);k(i.tw);S(i.topic_scaled)});return true};b=function(t,e,i){var n=function(e){if(e){VIS=utils.deep_replace(utils.clone(a.vis_template),e);a.m.set_topic_labels(VIS.topic_labels);a.m.set_topic_ids(VIS.topic_ids)}else{view.warning("Unable to load model info from "+t)}a.model_vis.set(a.id,e);i()};if(e){n(e);return}if(a.model_vis.has(a.id)){n(a.model_vis.get(a.id));return}g(t,function(e,t){if(typeof t==="string"){n(JSON.parse(t))}else{n()}})};A=function(i){var n,r;r=function(e){a.condition={field:VIS.condition.spec.field,name:VIS.condition.name||VIS.condition.spec.field,type:VIS.condition.type};a.m.meta_condition(a.condition.field,metadata.key[a.condition.type],VIS.condition.spec,l)};if(a.m.ready("meta")){r();return}n=a.shared.meta.get(i).find(function(e){var t=a.ms.get(e);return t&&t.ready("meta")});if(n){a.m.meta(a.ms.get(n).meta());r();return}if(typeof a.metadata==="function"){n=a.metadata(VIS.metadata.spec)}else if(VIS.metadata.type==="base"){n=metadata(VIS.metadata.spec)}else if(VIS.metadata.type==="dfr"){n=metadata.dfr(VIS.metadata.spec)}else{n=metadata.dfr();view.warning("Unknown metadata.type; defaulting to dfr.")}if(typeof a.bib==="function"){n.bib(a.bib(VIS.bib.spec))}else if(VIS.bib.type==="base"){n.bib(bib(VIS.bib.spec))}else if(VIS.bib.type==="dfr"){n.bib(bib.dfr(VIS.bib.spec))}else{n.bib(bib.dfr(VIS.bib.spec));view.warning("Unknown bib.type; defaulting to dfr.")}g(i,function(e,t){if(typeof t==="string"){n.from_string(t);a.m.meta(n);r();l()}else{view.error("Unable to load metadata from "+i)}})};x=function(i){var n=function(){a.proper=VIS.proper;if(a.proper===undefined){a.proper=a.m.proper()}d3.selectAll(".proper").classed("hidden",!a.proper);d3.selectAll(".not-proper").classed("hidden",a.proper)};if(a.m.ready("dt")){n();return}g(i,function(e,t){a.m.set_dt(t,function(e){if(e.success){n();l()}else{view.error("Unable to load document topics from "+i)}})})};k=function(i){var n=function(){view.topic.dropdown({topics:d3.range(a.m.n()).map(function(e){return{topic:e,id:a.m.topic_id(e),words:a.m.topic_words(e,VIS.model_view.words),label:a.m.topic_label(e),hidden:w(e)}}),overview_words:a.settings.overview_words});l()};if(a.m.ready("tw")){n();return}g(i,function(e,t){if(typeof t==="string"){a.m.set_tw(t);n()}else{view.error("Unable to load topic words from "+i)}})};S=function(e){var i=function(){d3.select("#nav_model_scaled").classed("disabled",!a.m.topic_scaled()).select("a").attr("href",f({type:"model",param:"scaled"}))};if(a.m.ready("topic_scaled")){i();return}g(e,function(e,t){if(typeof t==="string"){a.m.set_topic_scaled(t)}else{a.m.set_topic_scaled("")}i();l()})};return o};