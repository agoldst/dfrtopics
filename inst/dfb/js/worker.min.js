"use strict";importScripts("utils.min.js");var my={conditional:{},conditional_total:{},doc_categories:{}},doc_topics_matrix,total_tokens,topic_docs,doc_topics,topic_conditional,conditional_total,topic_docs_conditional,PROPER_TOLERANCE=.01;doc_topics_matrix=function(t){var e={},i=t;if(i.p&&i.p.length){i.n=i.p.length-1}i.get=function(t,i){var o,a,e,n;if(!this.x){return undefined}if(t===undefined){return this}if(i===undefined){n=[];for(e=0;e<this.n;e+=1){n.push(this.get(t,e))}return n}o=this.p[i];a=utils.bisect_left(this.i.slice(o,this.p[i+1]),t);n=this.i[a+o]===t?this.x[a+o]:0;return n};i.row_sum=function(t){var i,o,a;if(!this.x){return undefined}if(!e.row_sum){e.row_sum=[]}if(t===undefined){for(o=0;o<this.n;o+=1){for(a=this.p[o];a<this.p[o+1];a+=1){if(e.row_sum[this.i[a]]===undefined){e.row_sum[this.i[a]]=0}e.row_sum[this.i[a]]+=this.x[a]}}return e.row_sum}if(!e.row_sum[t]){i=0;for(o=0;o<this.n;o+=1){i+=this.get(t,o)}e.row_sum[t]=i}return e.row_sum[t]};i.col_sum=function(t){var i;if(!e.col_sum){e.col_sum=[]}if(t===undefined){for(i=0;i<this.n;i+=1){this.col_sum(i)}return e.col_sum}if(!e.col_sum[t]){e.col_sum[t]=0;for(i=this.p[t];i<this.p[t+1];i+=1){e.col_sum[t]+=this.x[i]}}return e.col_sum[t]};return i};total_tokens=function(){var t,i=0;for(t=0;t<my.dt.x.length;t+=1){i+=my.dt.x[t]}return i};topic_docs=function(t,i){return topic_docs_conditional(t,undefined,undefined,i)};doc_topics=function(t,i){var o=[],a,e;for(a=0;a<my.dt.n;a+=1){e=my.dt.get(t,a);if(e>0){o.push({topic:a,weight:e})}}o.sort(function(t,i){return utils.desc(t.weight,i.weight)||utils.desc(t.t,i.t)});return utils.shorten(o,i,function(t,i){return t[i].weight})};topic_conditional=function(t,i){var o,a,e;if(!my.conditional[t]){my.conditional[t]={}}if(i===undefined){o=[];for(a=0;a<my.dt.n;a+=1){o.push(topic_conditional(t,a))}return o}if(my.conditional[t][i]){return my.conditional[t][i]}o={};for(a=my.dt.p[i];a<my.dt.p[i+1];a+=1){e=my.doc_categories[t][my.dt.i[a]];if(o[e]){o[e]+=my.dt.x[a]}else{o[e]=my.dt.x[a]}}for(e in o){if(o.hasOwnProperty(e)){o[e]/=conditional_total(t,e)}}my.conditional[t][i]=o;return o};conditional_total=function(t,i){var o,a,e;if(!my.conditional_total[t]){o={};for(e=0;e<my.dt.i.length;e+=1){a=my.doc_categories[t][my.dt.i[e]];if(o[a]){o[a]+=my.dt.x[e]}else{o[a]=my.dt.x[e]}}my.conditional_total[t]=o}return i!==undefined?my.conditional_total[t][i]:my.conditional_total[t]};topic_docs_conditional=function(t,i,o,a){var e=my.dt.p[t],n=my.dt.p[t+1],s,d=[],c,r,u,l=[];for(s=e;s<n;s+=1){if(i===undefined||my.doc_categories[i][my.dt.i[s]]===o){d.push({doc:my.dt.i[s],frac:my.dt.x[s]/my.dt.row_sum(my.dt.i[s]),weight:my.dt.x[s]})}}if(a>=d.length){d.sort(function(t,i){return utils.desc(t.frac,i.frac)||utils.desc(t.doc,i.doc)});return d}l=d.slice(0,a).sort(function(t,i){return utils.asc(t.frac,i.frac)||utils.asc(t.doc,i.doc)});c=utils.bisector_left(function(t){return t.frac});for(u=a;u<d.length;u+=1){r=c(l,d[u].frac);if(r>0){l.splice(r,0,d[u]);l.shift()}else if(l[0].frac===d[u].frac){l.unshift(d[u])}}return utils.shorten(l.reverse(),a,function(t,i){return t[i].frac})};onmessage=function(t){var i;if(t.data.what==="set_dt"){my.dt=doc_topics_matrix(t.data.dt);if(my.dt){i=my.dt.row_sum().reduce(function(t,i){return t&&Math.abs(i-1)<PROPER_TOLERANCE},true)}postMessage({what:"set_dt",result:{success:my.dt!==undefined,proper:i}})}else if(t.data.what==="set_doc_categories"){my.doc_categories[t.data.v]=t.data.keys;postMessage({what:"set_doc_categories/"+t.data.v,result:my.doc_categories[t.data.v]!==undefined})}else if(t.data.what==="total_tokens"){postMessage({what:"total_tokens",result:total_tokens()})}else if(t.data.what==="topic_docs"){postMessage({what:"topic_docs/"+t.data.t+"/"+t.data.n,result:topic_docs(t.data.t,t.data.n)})}else if(t.data.what==="doc_topics"){postMessage({what:"doc_topics/"+t.data.d+"/"+t.data.n,result:doc_topics(t.data.d,t.data.n)})}else if(t.data.what==="topic_total"){postMessage({what:"topic_total/"+t.data.t,result:my.dt.col_sum(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="topic_conditional"){postMessage({what:"topic_conditional/"+t.data.v+"/"+t.data.t,result:topic_conditional(t.data.v,t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="conditional_total"){postMessage({what:"conditional_total/"+t.data.v+"/"+t.data.key,result:conditional_total(t.data.v,t.data.key==="all"?undefined:t.data.key)})}else if(t.data.what==="topic_docs_conditional"){postMessage({what:"topic_docs_conditional/"+t.data.t+"/"+t.data.v+"/"+t.data.key+"/"+t.data.n,result:topic_docs_conditional(t.data.t,t.data.v,t.data.key,t.data.n)})}else{postMessage({what:"error"})}};